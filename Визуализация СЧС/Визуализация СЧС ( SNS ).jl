using Printf # –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
using CSV # –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CSV-—Ñ–∞–π–ª–∞–º–∏
using DataFrames # –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
using Base.Threads # –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å
using ProgressMeter # –ø–æ–¥–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
using Plots # –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
using StatsPlots # –ø–æ–¥–∫–ª—é—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
using Statistics # –ø–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—Å—Ä–µ–¥–Ω–µ–µ, –º–∞–∫—Å–∏–º—É–º –∏ —Ç.–¥.)
using Colors # –ø–æ–¥–∫–ª—é—á–∞–µ–º —Ä–∞–±–æ—Ç—É —Å —Ü–≤–µ—Ç–∞–º–∏

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –°–ß–°

function split_number_str(N::Integer, m::Integer) # —Ñ—É–Ω–∫—Ü–∏—è: —Ä–∞–∑–±–∏—Ç—å —á–∏—Å–ª–æ N –Ω–∞ m —á–∞—Å—Ç–µ–π (–∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
s = string(N) # –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫—É
if N < 10 # –µ—Å–ª–∏ —á–∏—Å–ª–æ –º–µ–Ω—å—à–µ 10 (–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ)
s = lpad(s, m, '0') # –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–ª–∏ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –±—ã–ª–æ —Ö–æ—Ç—è –±—ã m —Å–∏–º–≤–æ–ª–æ–≤
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
len = length(s) # —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Ü–∏—Ñ—Ä –≤ —á–∏—Å–ª–µ
base_len = div(len, m) # —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –≤ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏ –∫–∞–∫ –º–∏–Ω–∏–º—É–º (—Ü–µ–ª–∞—è —á–∞—Å—Ç—å –æ—Ç –¥–µ–ª–µ–Ω–∏—è)
remainder = len % m # —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä "–æ—Å—Ç–∞–ª–æ—Å—å" –ø–æ—Å–ª–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è
parts = String[] # —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —á–∞—Å—Ç–µ–π
idx = 1 # —Å –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å—Ç—Ä–æ–∫–µ –Ω–∞—á–∏–Ω–∞—Ç—å –±—Ä–∞—Ç—å —á–∞—Å—Ç—å
for i in 1:m # –ø–æ–≤—Ç–æ—Ä—è–µ–º m —Ä–∞–∑ (–ø–æ —á–∏—Å–ª—É —á–∞—Å—Ç–µ–π)
current_len = base_len + (i <= remainder ? 1 : 0) # –µ—Å–ª–∏ —á–∞—Å—Ç—å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ "–æ—Å—Ç–∞—Ç–æ–∫", –¥–æ–±–∞–≤–ª—è–µ–º 1 —Ü–∏—Ñ—Ä—É
push!(parts, s[idx:idx+current_len-1]) # –≤—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
idx += current_len # —Å–¥–≤–∏–≥–∞–µ–º—Å—è –≤–ø—Ä–∞–≤–æ –Ω–∞ –¥–ª–∏–Ω—É –≤–∑—è—Ç–æ–π —á–∞—Å—Ç–∏
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ —á–∞—Å—Ç—è–º
return parts # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Å—Ç–µ–π
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

function multiply_preserve_length(part::String, k::Integer) # —Ñ—É–Ω–∫—Ü–∏—è: —É–º–Ω–æ–∂–∏—Ç—å —á–∞—Å—Ç—å –Ω–∞ k –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª–∏–Ω—É
if isempty(part) # –µ—Å–ª–∏ —á–∞—Å—Ç—å –ø—É—Å—Ç–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "")
return "0" # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "0", —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
num = parse(BigInt, part) * k # –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ –∏ —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ k
result = string(num) # –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É
return lpad(result, length(part), '0') # –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–ª–∏ —Å–ª–µ–≤–∞, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ä–æ—á–µ –∏—Å—Ö–æ–¥–Ω–æ–π —á–∞—Å—Ç–∏
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

function remove_leading_zeros(s::String) # —Ñ—É–Ω–∫—Ü–∏—è: —É–±—Ä–∞—Ç—å –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏
if all(c -> c == '0', s) # –µ—Å–ª–∏ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã ‚Äî –Ω—É–ª–∏
return "0" # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "0"
else # –∏–Ω–∞—á–µ
idx = findfirst(c -> c != '0', s) # –Ω–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –ù–ï-–Ω—É–ª–µ–≤—É—é —Ü–∏—Ñ—Ä—É
return s[idx:end] # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–æ –∫–æ–Ω—Ü–∞
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

function compare_pq_nk(pq::String, nk::String) # —Ñ—É–Ω–∫—Ü–∏—è: —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ —á–∏—Å–ª–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
if pq == nk # –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç
return "–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ" # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ"
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
min_len = min(length(pq), length(nk)) # —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å (–¥–ª–∏–Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Ç—Ä–æ–∫–∏)
prefix_len = 0 # —Å—á—ë—Ç—á–∏–∫ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Ü–∏—Ñ—Ä –≤ –Ω–∞—á–∞–ª–µ
for i in 1:min_len # –∏–¥—ë–º –æ—Ç –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã
pq[i] == nk[i] ? prefix_len += 1 : break # –µ—Å–ª–∏ —Ü–∏—Ñ—Ä—ã —Å–æ–≤–ø–∞–ª–∏ ‚Äî +1, –∏–Ω–∞—á–µ –≤—ã–π—Ç–∏ –∏–∑ —Ü–∏–∫–ª–∞
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
suffix_len = 0 # —Å—á—ë—Ç—á–∏–∫ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Ü–∏—Ñ—Ä –≤ –∫–æ–Ω—Ü–µ
for i in 1:min_len # –∏–¥—ë–º –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ü–∏—Ñ—Ä—ã (–ø–æ –∏–Ω–¥–µ–∫—Å—É —Å –∫–æ–Ω—Ü–∞)
pq[end - i + 1] == nk[end - i + 1] ? suffix_len += 1 : break # –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª–∏ ‚Äî +1, –∏–Ω–∞—á–µ –≤—ã–π—Ç–∏
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ —Å—É—Ñ—Ñ–∏–∫—Å—É
if prefix_len > 0 && suffix_len > 0 # –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –∏ –Ω–∞—á–∞–ª–æ, –∏ –∫–æ–Ω–µ—Ü
return "–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü" # —ç—Ç–æ –°–ß–°-—è–≤–ª–µ–Ω–∏–µ
elseif prefix_len > 0 # –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ
return "–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ" # —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
elseif suffix_len > 0 # –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü
return "–¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü" # —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
else # –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ
return "–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π" # –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

function analyze_sns(N::Integer, m::Integer, k::Integer) # —Ñ—É–Ω–∫—Ü–∏—è: –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –°–ß–° –¥–ª—è —á–∏—Å–ª–∞ N
N_str = string(N) # –∏—Å—Ö–æ–¥–Ω–æ–µ —á–∏—Å–ª–æ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
nk_str = string(N * k) # —ç—Ç–∞–ª–æ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (N*k) –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
parts = split_number_str(N, m) # —Ä–∞–∑–±–∏–≤–∞–µ–º N –Ω–∞ m —á–∞—Å—Ç–µ–π
multiplied_parts = [multiply_preserve_length(p, k) for p in parts] # —É–º–Ω–æ–∂–∞–µ–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å –Ω–∞ k
pq_str = join(multiplied_parts) # —Å–∫–ª–µ–∏–≤–∞–µ–º —á–∞—Å—Ç–∏ –æ–±—Ä–∞—Ç–Ω–æ
pq_clean = remove_leading_zeros(pq_str) # —É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –∏–∑ PQ
nk_clean = remove_leading_zeros(nk_str) # —É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –∏–∑ NK
result = compare_pq_nk(pq_clean, nk_clean) # —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏ –ø–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

min_len = min(length(pq_clean), length(nk_clean)) # —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –º–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å
prefix_len = 0 # —Å—á—ë—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞
for i in 1:min_len # –æ—Ç –Ω–∞—á–∞–ª–∞
pq_clean[i] == nk_clean[i] ? prefix_len += 1 : break # —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Üí +1, –∏–Ω–∞—á–µ –≤—ã–π—Ç–∏
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞
suffix_len = 0 # —Å—á—ë—Ç—á–∏–∫ –∫–æ–Ω—Ü–∞
for i in 1:min_len # –æ—Ç –∫–æ–Ω—Ü–∞
pq_clean[end - i + 1] == nk_clean[end - i + 1] ? suffix_len += 1 : break # —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Üí +1, –∏–Ω–∞—á–µ –≤—ã–π—Ç–∏
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞

return ( # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
N = string(N), # —á–∏—Å–ª–æ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
m = m, # —á–∏—Å–ª–æ —á–∞—Å—Ç–µ–π
k = k, # –º–Ω–æ–∂–∏—Ç–µ–ª—å
digits = length(N_str), # —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —á–∏—Å–ª–µ
PQ = pq_clean, # —Ä–µ–∑—É–ª—å—Ç–∞—Ç (PQ)
NK = nk_clean, # —ç—Ç–∞–ª–æ–Ω (NK)
result = result, # —Ç–∏–ø —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
prefix_len = prefix_len, # –¥–ª–∏–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ –Ω–∞—á–∞–ª–∞
suffix_len = suffix_len # –¥–ª–∏–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ –∫–æ–Ω—Ü–∞
)
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

# –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ –°–ß–°

function run_sns_experiment(N_values, m_list, k_list) # —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
results_df = DataFrame( # —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
N = String[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —á–∏—Å–µ–ª
m = Int[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è m
k = Int[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è k
digits = Int[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–∏—Ñ—Ä
result = String[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Ç–∏–ø–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
prefix_len = Int[], # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è –¥–ª–∏–Ω—ã –Ω–∞—á–∞–ª–∞
suffix_len = Int[] # —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è –¥–ª–∏–Ω—ã –∫–æ–Ω—Ü–∞
)

lock_df = ReentrantLock() # –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏

@showprogress "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ SNS..." for N in N_values # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∏—Å–ª–∞ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º)
for m in m_list # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è m
for k in k_list # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è k
try # –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å
res = analyze_sns(N, m, k) # –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –°–ß–°
lock(lock_df) do # –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
push!(results_df, ( # –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
res.N, res.m, res.k, res.digits,
res.result, res.prefix_len, res.suffix_len
))
end # –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
catch # –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
continue # –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ
end # –∫–æ–Ω–µ—Ü try-catch
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ k
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ m
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ N

CSV.write("sns_experiment.csv", results_df) # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ —Ñ–∞–π–ª
return results_df # –≤–µ—Ä–Ω—É—Ç—å —Ç–∞–±–ª–∏—Ü—É
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –°–ß–°

function visualize_sns(df::DataFrame) # —Ñ—É–Ω–∫—Ü–∏—è: –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
mkpath("sns_plots") # —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤

if nrow(df) == 0 # –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è
error("–î–∞—Ç–∞—Ñ—Ä–µ–π–º –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.") # –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è

# –¶–≤–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞
color_map = Dict( # —Å–ª–æ–≤–∞—Ä—å: –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Å–≤–æ–π —Ü–≤–µ—Ç
"–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ" => RGB(0.2, 0.4, 0.8),   # üîµ —Å–∏–Ω–∏–π
"–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü"    => RGB(0.9, 0.7, 0.1),   # üü° –∂—ë–ª—Ç—ã–π
"–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ"      => RGB(0.8, 0.1, 0.1),   # üî¥ –∫—Ä–∞—Å–Ω—ã–π
"–¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü"      => RGB(0.1, 0.7, 0.3),   # üü¢ –∑–µ–ª—ë–Ω—ã–π
"–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π"    => RGB(0.5, 0.5, 0.5)    # —Å–µ—Ä—ã–π
)

# 1. –ë–∞—Ä - –≥—Ä–∞—Ñ–∏–∫: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Ç–∏–ø–∞–º

result_counts = combine(groupby(df, :result), nrow => :count) # —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å—Ç—Ä–µ—Ç–∏–ª—Å—è –∫–∞–∂–¥—ã–π —Ç–∏–ø
plt1 = bar( # —Ä–∏—Å—É–µ–º —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
result_counts.result, result_counts.count, # –æ—Å—å X ‚Äî —Ç–∏–ø—ã, –æ—Å—å Y ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
title="–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ SNS", # –∑–∞–≥–æ–ª–æ–≤–æ–∫
xlabel="–¢–∏–ø —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è", ylabel="–ß–∞—Å—Ç–æ—Ç–∞", # –ø–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
legend = false, # –±–µ–∑ –ª–µ–≥–µ–Ω–¥—ã
size = (800, 500), # —Ä–∞–∑–º–µ—Ä
color = [get(color_map, label, :gray) for label in result_counts.result], # —Ü–≤–µ—Ç–∞ –∏–∑ –∫–∞—Ä—Ç—ã
background_color = :white, # –±–µ–ª—ã–π —Ñ–æ–Ω
foreground_color = :black # —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
)
savefig(plt1, "sns_plots/sns_result_types.png") # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫

# 2. –ü—Ä–µ—Ñ–∏–∫—Å vs —Å—É—Ñ—Ñ–∏–∫—Å

plt2 = scatter( # —Ç–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
[], [], # –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
title="–°–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –∏ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤ –≤ SNS", # –∑–∞–≥–æ–ª–æ–≤–æ–∫
xlabel="–î–ª–∏–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞", # –æ—Å—å X
ylabel="–î–ª–∏–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ —Å—É—Ñ—Ñ–∏–∫—Å–∞", # –æ—Å—å Y
legend = :topleft, # –ª–µ–≥–µ–Ω–¥–∞ –≤–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞
size = (800, 500), # —Ä–∞–∑–º–µ—Ä
background_color = :white, # –±–µ–ª—ã–π —Ñ–æ–Ω
foreground_color = :black # —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
)

for result_type in ["–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ", "–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü", "–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ", "–¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü"] # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
subset = df[df.result .== result_type, :] # –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
if nrow(subset) > 0 # –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –µ—Å—Ç—å
scatter!(plt2, subset.prefix_len, subset.suffix_len, # –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏
color=color_map[result_type], markersize=6, label=result_type) # —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä, –ø–æ–¥–ø–∏—Å—å
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞

savefig(plt2, "sns_plots/sns_prefix_vs_suffix.png") # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å

# 3. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤

plt3 = histogram( # –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞
df.suffix_len, # –≤—Å–µ –¥–ª–∏–Ω—ã —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤
title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤", # –∑–∞–≥–æ–ª–æ–≤–æ–∫
xlabel="–î–ª–∏–Ω–∞ —Å—É—Ñ—Ñ–∏–∫—Å–∞", ylabel="–ß–∞—Å—Ç–æ—Ç–∞", # –æ—Å–∏
legend = false, # –±–µ–∑ –ª–µ–≥–µ–Ω–¥—ã
size = (800, 500), # —Ä–∞–∑–º–µ—Ä
color = RGB(0.1, 0.7, 0.3), # üíö –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π
background_color = :white, # –±–µ–ª—ã–π —Ñ–æ–Ω
foreground_color = :black # —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
)
savefig(plt3, "sns_plots/sns_suffix_hist.png") # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å

# 4. –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
m_vals = sort(unique(df.m)) # –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ m (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
k_vals = sort(unique(df.k)) # –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ k (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
heat_data = zeros(Float64, length(m_vals), length(k_vals)) # –º–∞—Ç—Ä–∏—Ü–∞ –Ω—É–ª–µ–π
has_data = false # —Ñ–ª–∞–≥: –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ

for (i, m_val) in enumerate(m_vals) # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ m
for (j, k_val) in enumerate(k_vals) # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ k
subset = df[(df.m .== m_val) .& (df.k .== k_val), :] # –≤—ã–±—Ä–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —ç—Ç–∏–º m –∏ k
if nrow(subset) > 0 # –µ—Å–ª–∏ –µ—Å—Ç—å
heat_data[i, j] = mean(subset.suffix_len) # —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å—É—Ñ—Ñ–∏–∫—Å–∞
has_data = true # –ø–æ–º–µ—Ç–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ k
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ m

clims_max = has_data ? maximum(heat_data) : 1.0 # –º–∞–∫—Å–∏–º—É–º –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–π —à–∫–∞–ª—ã
plt4 = heatmap( # —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
k_vals, m_vals, heat_data', # –æ—Å—å X ‚Äî k, –æ—Å—å Y ‚Äî m
title="–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å—É—Ñ—Ñ–∏–∫—Å–∞: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (m, k)", # –∑–∞–≥–æ–ª–æ–≤–æ–∫
xlabel="–ú–Ω–æ–∂–∏—Ç–µ–ª—å k", ylabel="–ß–∏—Å–ª–æ —á–∞—Å—Ç–µ–π m", # –æ—Å–∏
color=:viridis, clims=(0, clims_max), # —Ü–≤–µ—Ç–∞ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω
legend = false # –±–µ–∑ –ª–µ–≥–µ–Ω–¥—ã
)
savefig(plt4, "sns_plots/sns_heatmap_m_k.png") # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å

# 5. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

target_categories = ["–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ", "–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü", "–¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü"] # —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
valid_rows = df[in.(df.result, Ref(target_categories)), :] # –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏

if nrow(valid_rows) > 0 # –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
counts = combine(groupby(valid_rows, :result), nrow => :count) # –ø–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
labels = counts.result # –Ω–∞–∑–≤–∞–Ω–∏—è
values = counts.count # –∑–Ω–∞—á–µ–Ω–∏—è

pie_colors = [get(color_map, label, :gray) for label in labels] # —Ü–≤–µ—Ç–∞

plt5 = pie( # –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
values, # —Ä–∞–∑–º–µ—Ä—ã —Å–µ–∫—Ç–æ—Ä–æ–≤
labels = [], # –±–µ–∑ –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ —Å–µ–∫—Ç–æ—Ä–∞—Ö
title = "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ SNS", # –∑–∞–≥–æ–ª–æ–≤–æ–∫
color = pie_colors, # —Ü–≤–µ—Ç–∞
legend = false, # –±–µ–∑ –ª–µ–≥–µ–Ω–¥—ã
size = (1000, 600), # —Ä–∞–∑–º–µ—Ä
xlims = (-2.0, 1.2), # —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ö–æ–ª—Å—Ç –≤–ª–µ–≤–æ
yticks = false, # –±–µ–∑ –º–µ—Ç–æ–∫ –ø–æ Y
xticks = false # –±–µ–∑ –º–µ—Ç–æ–∫ –ø–æ X
)

legend_x = -1.9 # –ø–æ–∑–∏—Ü–∏—è X –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã (–ø–æ—á—Ç–∏ —É –∫—Ä–∞—è)
legend_y = 0.4 # –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è Y
dy = 0.12 # —à–∞–≥ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏
for (i, label) in enumerate(labels) # –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
color = color_map[label] # –≤–∑—è—Ç—å —Ü–≤–µ—Ç
annotate!(plt5, (legend_x, legend_y, text("‚ñ†", :center, 14, color=color))) # –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ —Ü–≤–µ—Ç–∞
annotate!(plt5, (legend_x + 0.12, legend_y, text(label, :left, 11))) # –ø–æ–¥–ø–∏—Å—å
legend_y -= dy # —Å–¥–≤–∏–Ω—É—Ç—å—Å—è –≤–Ω–∏–∑
end # –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞

savefig(plt5, "sns_plots/sns_pie_chart.png") # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

total = nrow(df) # –≤—Å–µ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
full_match = sum(df.result .== "–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ") # —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
both_ends = sum(df.result .== "–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü") # —Å–∫–æ–ª—å–∫–æ –°–ß–°-—è–≤–ª–µ–Ω–∏–π
only_prefix = sum(df.result .== "–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ") # —Å–∫–æ–ª—å–∫–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–∞
only_suffix = sum(df.result .== "–¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü") # —Å–∫–æ–ª—å–∫–æ —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ü–∞
none = sum(df.result .== "–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π") # —Å–∫–æ–ª—å–∫–æ –±–µ–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

println("\n=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–ê –ü–û SNS ===") # –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
println("‚Ä¢ –í—Å–µ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤: $total") # –∏—Ç–æ–≥–∏
println("‚Ä¢ –ü–æ–ª–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: $full_match")
println("‚Ä¢ SNS-—è–≤–ª–µ–Ω–∏–µ (–Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü): $both_ends")
println("‚Ä¢ –¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ: $only_prefix")
println("‚Ä¢ –¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—Ü: $only_suffix")
println("‚Ä¢ –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: $none")

if only_prefix == 0 # –µ—Å–ª–∏ "—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–∞" –Ω–µ—Ç
println("\n‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –Ω–∞—á–∞–ª—É –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è.") # —É—Å–ø–µ—Ö
else # –∏–Ω–∞—á–µ
println("\n‚ùó –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª—É—á–∞–∏ '—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–∞' ‚Äî —Ç—Ä–µ–±—É—é—Ç –∞–Ω–∞–ª–∏–∑–∞.") # –æ—à–∏–±–∫–∞
end # –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è

println("\n–ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É 'sns_plots/'") # —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏
end # –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏

# –ó–∞–ø—É—Å–∫

N_test = [ # —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
big"99999"^big"99999", # –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ! –í–∞–º –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –ø–∞–º—è—Ç–∏!
]

m_range = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 25, 30, 35, 45, 50] # –∑–Ω–∞—á–µ–Ω–∏—è m
k_range = [2, 3, 5, 7, 9, 10, 11, 15, 20, 25, 35, 40, 50, 100] # –∑–Ω–∞—á–µ–Ω–∏—è k

println("–ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ Structural Numerical Symmetry (SNS)...") # —Å–æ–æ–±—â–µ–Ω–∏–µ
df_sns = run_sns_experiment(N_test, m_range, k_range) # –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
visualize_sns(df_sns) # –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏

println("\n‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:") # –∏—Ç–æ–≥
println("   ‚Ä¢ –î–∞–Ω–Ω—ã–µ: sns_experiment.csv")
println("   ‚Ä¢ –ì—Ä–∞—Ñ–∏–∫–∏: sns_plots/")